image: ghcr.io/astral-sh/uv:python3.11-bookworm

stages:
  - lint_test
  - security
  - build
  - release

variables:
  UV_LINK_MODE: "copy"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .venv/
    - .cache/uv/

lint_test:
  stage: lint_test
  script:
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e .[dev]
    - ruff check .
    - mypy src
    - pytest -q
  artifacts:
    when: always
    reports:
      junit: junit.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

security:
  stage: security
  script:
    - uvx gitleaks detect --no-git -v
    - uvx bandit -r -q src
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

build_image:
  stage: build
  image: gcr.io/kaniko-project/executor:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "{"auths":{"ghcr.io":{"username":"$GHCR_USERNAME","password":"$GHCR_TOKEN"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile Dockerfile --destination ghcr.io/$GHCR_USERNAME/compliance-copilot:${CI_COMMIT_TAG}
