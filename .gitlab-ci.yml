image: ghcr.io/astral-sh/uv:python3.11-bookworm

stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  UV_LINK_MODE: "copy"
  COVERAGE_THRESHOLD: "80"

# Cache uv packages and venv for faster builds
cache:
  key:
    files:
      - pyproject.toml
  paths:
    - .venv/
    - .cache/uv/

# Hidden job for common setup
.setup_python:
  before_script:
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e .[dev]

# Linting stage
ruff:
  extends: .setup_python
  stage: lint
  script:
    - ruff check . --output-format=gitlab > ruff-report.json || true
    - ruff check .
  artifacts:
    reports:
      codequality: ruff-report.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

format_check:
  extends: .setup_python
  stage: lint
  script:
    - ruff format --check .
    - black --check .
    - isort --check-only .
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

mypy:
  extends: .setup_python
  stage: lint
  script:
    - mypy src --junit-xml=mypy-report.xml
  artifacts:
    reports:
      junit: mypy-report.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Testing stage
pytest:
  extends: .setup_python
  stage: test
  script:
    - pytest --junitxml=junit.xml --cov-report=xml --cov-report=html --cov-report=term
    - coverage report --fail-under=$COVERAGE_THRESHOLD
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Security scanning stage
gitleaks:
  stage: security
  script:
    - uvx gitleaks detect --no-git -v --report-path gitleaks-report.json
  artifacts:
    reports:
      secret_detection: gitleaks-report.json
    expire_in: 1 week
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

bandit:
  stage: security
  script:
    - uvx bandit -r src -f json -o bandit-report.json || true
    - uvx bandit -r src
  artifacts:
    reports:
      sast: bandit-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

safety:
  stage: security
  script:
    - uvx safety check --json || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Dependency scanning
dependency_scan:
  extends: .setup_python
  stage: security
  script:
    - uv pip list --format=json > dependencies.json
    - uvx pip-audit --format=json || true
  artifacts:
    paths:
      - dependencies.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"

# Container build stage
build_image:
  stage: build
  image: gcr.io/kaniko-project/executor:latest
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"ghcr.io\":{\"username\":\"$GHCR_USERNAME\",\"password\":\"$GHCR_TOKEN\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor \
        --context $CI_PROJECT_DIR \
        --dockerfile Dockerfile \
        --destination ghcr.io/$GHCR_USERNAME/compliance-copilot:${CI_COMMIT_TAG} \
        --destination ghcr.io/$GHCR_USERNAME/compliance-copilot:latest \
        --cache=true \
        --cache-ttl=24h
  rules:
    - if: $CI_COMMIT_TAG

# Container security scanning
container_scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --format json --output trivy-report.json ghcr.io/$GHCR_USERNAME/compliance-copilot:${CI_COMMIT_TAG} || true
  dependencies:
    - build_image
  artifacts:
    reports:
      container_scanning: trivy-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_TAG

# Deployment stage (placeholder)
deploy_staging:
  stage: deploy
  script:
    - echo "Deploy to staging environment"
    - echo "Image: ghcr.io/$GHCR_USERNAME/compliance-copilot:${CI_COMMIT_TAG}"
  environment:
    name: staging
    url: https://staging.compliance-copilot.example.com
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

deploy_production:
  stage: deploy
  script:
    - echo "Deploy to production environment"
    - echo "Image: ghcr.io/$GHCR_USERNAME/compliance-copilot:${CI_COMMIT_TAG}"
  environment:
    name: production
    url: https://compliance-copilot.example.com
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
      when: manual
  needs:
    - deploy_staging
